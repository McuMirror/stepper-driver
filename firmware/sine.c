#include "sine.h"
#include "hw.h"

const int16_t sine_table[256] = {1, 201, 402, 603, 804, 1005, 1206, 1407, 1607, 1808, 2009, 2210, 2410, 2611, 2811, 3011, 3211, 3411, 3611, 3811, 4011, 4210, 4409, 4609, 4808, 5006, 5205, 5403, 5602, 5800, 5997, 6195, 6392, 6589, 6786, 6983, 7179, 7375, 7571, 7766, 7961, 8156, 8351, 8545, 8739, 8933, 9126, 9319, 9512, 9704, 9896, 10087, 10278, 10469, 10659, 10849, 11039, 11228, 11416, 11605, 11793, 11980, 12167, 12353, 12539, 12725, 12910, 13094, 13278, 13462, 13645, 13828, 14010, 14191, 14372, 14552, 14732, 14912, 15090, 15269, 15446, 15623, 15800, 15976, 16151, 16325, 16499, 16673, 16846, 17018, 17189, 17360, 17530, 17700, 17869, 18037, 18204, 18371, 18537, 18703, 18868, 19032, 19195, 19358, 19519, 19681, 19841, 20001, 20159, 20318, 20475, 20631, 20787, 20942, 21097, 21250, 21403, 21555, 21706, 21856, 22005, 22154, 22301, 22448, 22594, 22740, 22884, 23027, 23170, 23312, 23453, 23593, 23732, 23870, 24007, 24144, 24279, 24414, 24547, 24680, 24812, 24943, 25073, 25201, 25330, 25457, 25583, 25708, 25832, 25955, 26077, 26199, 26319, 26438, 26557, 26674, 26790, 26905, 27020, 27133, 27245, 27356, 27466, 27576, 27684, 27791, 27897, 28002, 28106, 28208, 28310, 28411, 28511, 28609, 28707, 28803, 28898, 28993, 29086, 29178, 29269, 29359, 29447, 29535, 29621, 29707, 29791, 29874, 29956, 30037, 30117, 30196, 30273, 30350, 30425, 30499, 30572, 30644, 30714, 30784, 30852, 30919, 30985, 31050, 31114, 31176, 31237, 31298, 31357, 31414, 31471, 31526, 31581, 31634, 31685, 31736, 31785, 31834, 31881, 31927, 31971, 32015, 32057, 32098, 32138, 32176, 32214, 32250, 32285, 32319, 32351, 32383, 32413, 32442, 32469, 32496, 32521, 32545, 32568, 32589, 32610, 32629, 32647, 32663, 32679, 32693, 32706, 32718, 32728, 32737, 32745, 32752, 32758, 32762, 32765, 32767};

#define LIMIT PWM_PERIOD

int16_t cosine(int16_t t, int16_t amp)
{
    int32_t result;

    t = t & 1023;

    if(t < 256) {
        result = (int32_t)sine_table[255 - t] * amp;
    } else if(t < 512) {
        result = -(int32_t)sine_table[t - 256] * amp;
    } else if(t < 768) {
        result = -(int32_t)sine_table[767 - t] * amp;
    } else {
        result = (int32_t)sine_table[t - 768] * amp;
    }

    if(result > LIMIT * 32767) {
        result = LIMIT * 32767;
    } else if(result < -LIMIT * 32767) {
        result = -LIMIT * 32767;
    }
    return (int16_t)(result >> 15);
}

int16_t sine(int16_t t, int16_t amp)
{
    int32_t result;

    t=t & 1023;

    if(t < 256) {
        result = (int32_t)sine_table[t] * amp;
    } else if(t < 512) {
        result = (int32_t)sine_table[511 - t] * amp;
    } else if(t < 768) {
        result = -(int32_t)sine_table[t - 512] * amp;
    } else {
        result = -(int32_t)sine_table[1023 - t] * amp;
    }
    if(result > LIMIT * 32767) {
        result = LIMIT * 32767;
    } else if(result < -LIMIT * 32767) {
        result = -LIMIT * 32767;
    }
    return (int16_t)(result >> 15);
}
